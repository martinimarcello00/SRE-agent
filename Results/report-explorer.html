<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRE Agent Report Explorer</title>
    <!-- Load Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for plotting --><script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom styles for the accordion */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .accordion-button.active + .accordion-content {
            max-height: 5000px; /* A large value to ensure content fits */
            overflow: visible;
        }
        .accordion-button .arrow {
            transition: transform 0.3s ease-out;
        }
        .accordion-button.active .arrow {
            transform: rotate(90deg);
        }
    </style>
</head>
<body class="h-full font-sans text-gray-800">
    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-blue-700 mb-2">SRE Agent Execution Report</h1>
            <p class="text-lg text-gray-600">An interactive explorer for the agent's findings and root cause analysis.</p>
        </header>

        <!-- File Upload Section --><div id="file-loader" class="bg-white p-6 rounded-lg shadow-md border border-blue-200 mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Load Report File</h2>
            <div class="flex items-center space-x-4">
                <input type="file" id="json-file-input" accept="application/json" class="block w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-lg file:border-0
                    file:text-sm file:font-semibold
                    file:bg-blue-50 file:text-blue-700
                    hover:file:bg-blue-100 transition duration-150
                "/>
                <button id="load-report-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition duration-150">
                    Load Report
                </button>
            </div>
            <div id="error-message" class="text-red-600 text-sm mt-4 hidden"></div>
        </div>

        <!-- Main Report Content (Initially Hidden) --><div id="report-content" class="hidden space-y-8">

            <!-- Experiment Name --><div id="experiment-name-card" class="bg-blue-600 text-white p-4 rounded-lg shadow-md text-center">
                <h2 class="text-2xl font-bold" id="experiment-name-display"></h2>
            </div>

            <!-- App Info Card --><div id="app-info-card" class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold text-blue-600 border-b border-gray-200 pb-2 mb-4">Application Info</h2>
                <div id="app-info">
                    <!-- Content will be injected by JS --></div>
            </div>

            <!-- Execution Statistics Card --><div id="execution-stats-card" class="bg-white p-6 rounded-lg shadow-md border border-purple-200">
                <h2 class="text-2xl font-semibold text-purple-700 border-b border-gray-200 pb-2 mb-4">Execution Statistics</h2>
                
                <!-- Run ID -->
                <div class="mb-4 p-3 bg-purple-50 border border-purple-200 rounded-lg">
                    <p class="text-sm text-gray-600">Run ID:</p>
                    <p class="text-lg font-mono text-purple-900" id="run-id">N/A</p>
                </div>

                <!-- Text Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <p class="text-sm text-gray-600">Total Runtime:</p>
                        <p class="text-lg font-bold text-gray-900" id="total-runtime">N/A</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Total Tokens Used:</p>
                        <p class="text-lg font-bold text-gray-900" id="total-tokens-used">N/A</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Model Cost:</p>
                        <p class="text-lg font-bold text-gray-900" id="model-cost">N/A</p>
                    </div>
                </div>

                <!-- Charts Grid --><div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <!-- Set relative position and a minimum height for Chart.js responsiveness -->
                    <div class="relative min-h-[300px]">
                        <canvas id="token-usage-chart"></canvas>
                    </div>
                    <div class="relative min-h-[300px]">
                        <canvas id="tokens-per-agent-chart"></canvas> <!-- ID updated for clarity -->
                    </div>
                </div>
            </div>

            <!-- Symptoms Section --><div class="bg-white p-6 rounded-lg shadow-md border border-yellow-200">
                <h2 class="text-3xl font-bold text-yellow-700 border-b border-gray-200 pb-2 mb-4">Symptoms Section (Triage Agent)</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    
                    <!-- Problematic Pods --><div>
                        <h3 class="text-2xl font-semibold text-red-600 mb-4">Problematic Pods</h3>
                        <div id="problematic-pods" class="space-y-4">
                            <!-- Content will be injected by JS --></div>
                    </div>

                    <!-- Problematic Traces --><div>
                        <h3 class="text-2xl font-semibold text-red-600 mb-4">Problematic Traces</h3>
                        <div id="problematic-traces-container" class="overflow-x-auto max-h-96 border rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trace ID</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sequence</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Error</th>
                                    </tr>
                                </thead>
                                <tbody id="problematic-traces" class="bg-white divide-y divide-gray-200">
                                    <!-- Content will be injected by JS --></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Problematic Metrics --><div class="lg:col-span-1">
                        <h3 class="text-2xl font-semibold text-red-600 mb-4">Problematic Metrics</h3>
                        <div id="problematic-metrics" class="space-y-4">
                            <!-- Content will be injected by JS --></div>
                    </div>

                    <!-- AI-Generated Symptoms --><div class="lg:col-span-1">
                        <h3 class="text-2xl font-semibold text-yellow-600 mb-4">AI-Generated Symptoms</h3>
                        <ul id="symptoms-list" class="list-disc list-inside space-y-2 text-sm">
                            <!-- Content will be injected by JS --></ul>
                    </div>
                </div>
            </div>

            <!-- Slow Traces Section --><div class="bg-white p-6 rounded-lg shadow-md border border-orange-200">
                <h2 class="text-3xl font-bold text-orange-700 border-b border-gray-200 pb-2 mb-4">Slow Traces</h2>
                <div id="slow-traces-container" class="space-y-4">
                    <!-- Content will be injected by JS --></div>
            </div>

            <!-- RCA Tasks Section --><div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <h2 class="text-3xl font-bold text-gray-800 border-b border-gray-200 pb-2 mb-4">RCA Tasks (Planner Agent)</h2>
                <div id="rca-tasks-list" class="space-y-3">
                    <!-- Content will be injected by JS --></div>
            </div>
            
            <!-- RCA Analyses Section --><div>
                <h2 class="text-3xl font-bold text-gray-800 mb-4">RCA Analyses & Tool Usage</h2>
                <div id="rca-analyses" class="space-y-4">
                    <!-- Accordions will be injected by JS --></div>
            </div>

            <!-- Final Report Card --><div class="bg-white p-6 rounded-lg shadow-xl border border-blue-200">
                <div class="flex justify-between items-center border-b border-gray-200 pb-2 mb-4">
                    <h2 class="text-3xl font-bold text-blue-800">Final Report (Supervisor Agent)</h2>
                    <button id="summarize-report-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm flex items-center">
                        <span class="mr-1">âœ¨</span> Summarize for Executive
                    </button>
                </div>
                <div id="final-report" class="space-y-4">
                    <!-- Content will be injected by JS --></div>
            </div>

        </div>
    </div>

    <!-- Gemini Modal --><div id="gemini-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl transform transition-all max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-2xl font-semibold text-blue-700">âœ¨ AI Assistant</h3>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <!-- Loading Spinner --><div id="modal-loading" class="flex flex-col items-center justify-center min-h-[200px]">
                <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600"></div>
                <p class="text-gray-600 mt-4">Thinking...</p>
            </div>
            <!-- Modal Content --><div id="modal-content" class="text-gray-700 whitespace-pre-line leading-relaxed hidden overflow-y-auto">
                <!-- Content injected by JS --></div>
        </div>
    </div>

    <script>
        // Store loaded data globally
        window.reportData = null;
        let tokenUsageChartInstance = null;
        let tokensPerAgentChartInstance = null;
        
        // This array will *only* store charts for the RCA accordions
        let activeRcaCharts = []; 

        // --- MODAL HANDLING ---
        const modal = document.getElementById('gemini-modal');
        const modalLoading = document.getElementById('modal-loading');
        const modalContent = document.getElementById('modal-content');
        const closeModalBtn = document.getElementById('close-modal-btn');

        function showModal(isLoading = true, content = '') {
            if (isLoading) {
                modalLoading.classList.remove('hidden');
                modalContent.classList.add('hidden');
            } else {
                modalLoading.classList.add('hidden');
                modalContent.textContent = content;
                modalContent.classList.remove('hidden');
            }
            modal.classList.remove('hidden');
        }

        function hideModal() {
            modal.classList.add('hidden');
        }

        // --- GEMINI API CALL ---
        async function callGeminiAPI(prompt, retries = 3, delay = 1000) {
            showModal(true); // Show loading spinner
            const apiKey = ""; // This is handled by the execution environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        console.error('API Error Response:', errorBody);
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        showModal(false, text); // Show result in modal
                        return text;
                    } else {
                        console.error('Invalid response structure:', result);
                        throw new Error('Invalid response structure from Gemini API.');
                    }
                } catch (error) {
                    console.error(`Gemini API call failed (attempt ${i + 1}/${retries}):`, error);
                    if (i === retries - 1) {
                        // Last retry failed
                        showModal(false, `Error: Could not get a response from the AI. ${error.message}`);
                        return null;
                    }
                    // Wait for exponential backoff
                    await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
                }
            }
        }


        // --- CHART HELPER ---
        // Predefined colors for charts to make them consistent
        const chartColors = [
            '#4F46E5', // Indigo
            '#10B981', // Emerald
            '#EF4444', // Red
            '#F59E0B', // Amber
            '#3B82F6', // Blue
            '#6366F1', // Indigo (light)
            '#14B8A6', // Teal
            '#EC4899', // Pink
            '#8B5CF6', // Violet
            '#06B6D4'  // Cyan
        ];

        function createPieChart(ctx, toolsStats, title = 'Tool Call Count per Task') {
            const labels = Object.keys(toolsStats);
            const data = Object.values(toolsStats);
            const backgroundColors = labels.map((_, i) => chartColors[i % chartColors.length]);

            const chart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Usage',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        title: {
                            display: true,
                            text: title
                        }
                    }
                }
            });
            // DO NOT push to global array here. Let the caller manage its instances.
            return chart; // Return chart instance
        }

        // --- RENDER FUNCTIONS ---
        function renderExperimentName(data) {
            const container = document.getElementById('experiment-name-display');
            // Use experiment_name from 'stats' block first, fallback to root
            const expName = (data.stats && data.stats.experiment_name) ? data.stats.experiment_name : (data.experiment_name || 'Experiment Report');
            container.textContent = expName;
        }

        function renderAppInfo(data) {
            const container = document.getElementById('app-info');
            if (!data.app_name) {
                container.innerHTML = `<p class="text-gray-500">App info not available.</p>`;
                return;
            }
            container.innerHTML = `
                <div class="mb-2">
                    <strong class="text-gray-700">App Name:</strong>
                    <span class="text-gray-900 ml-2">${data.app_name}</span>
                </div>
                <div class="mb-2">
                    <strong class="text-gray-700">Namespace:</strong>
                    <span class="text-gray-900 ml-2">${data.target_namespace}</span>
                </div>
                <div>
                    <strong class="text-gray-700">Summary:</strong>
                    <p class="text-gray-600 text-sm mt-1 whitespace-pre-line">${data.app_summary ? data.app_summary.trim() : 'N/A'}</p>

                </div>
            `;
        }

        function renderExecutionStatistics(data) {
            const stats = data.stats; 
            if (!stats) {
                document.getElementById('execution-stats-card').classList.add('hidden');
                return;
            }
            document.getElementById('execution-stats-card').classList.remove('hidden');

            // Populate new Run ID field
            document.getElementById('run-id').textContent = stats.run_id || 'N/A';

            document.getElementById('total-runtime').textContent = stats.execution_time_seconds ? `${stats.execution_time_seconds.toFixed(2)}s` : 'N/A';
            document.getElementById('total-tokens-used').textContent = stats.total_tokens ? stats.total_tokens.toLocaleString() : 'N/A';
            document.getElementById('model-cost').textContent = stats.total_cost ? `$${stats.total_cost.toFixed(4)}` : 'N/A';
            
            // Process agent_stats for charts
            let total_input_tokens = 0;
            let total_output_tokens = 0;
            const tokens_per_agent = {}; // Changed from runs_per_agent

            if (stats.agent_stats) {
                for (const agentName in stats.agent_stats) {
                    const agentData = stats.agent_stats[agentName];
                    if (agentData && typeof agentData === 'object') {
                        
                        // New logic for 'Total Tokens Per Agent' chart
                        if (agentData.total_tokens) { 
                            // Format agent name: "supervisor_agent" -> "Supervisor"
                            const formattedName = agentName.replace('_agent', '').replace(/^\w/, c => c.toUpperCase());
                            tokens_per_agent[formattedName] = agentData.total_tokens; 
                        }

                        // Logic for 'Input vs Output' chart
                        if (agentData.input_tokens) {
                            total_input_tokens += agentData.input_tokens;
                        }
                        if (agentData.output_tokens) {
                            total_output_tokens += agentData.output_tokens;
                        }
                    }
                }
            }

            // Token Usage Chart (Input vs Output)
            if (tokenUsageChartInstance) tokenUsageChartInstance.destroy(); // Destroy previous instance
            const tokenUsageCtx = document.getElementById('token-usage-chart').getContext('2d');
            if (total_input_tokens > 0 || total_output_tokens > 0) {
                const tokenStats = {
                    'Input Tokens': total_input_tokens,
                    'Output Tokens': total_output_tokens
                };
                // Create new instance and store it
                tokenUsageChartInstance = createPieChart(tokenUsageCtx, tokenStats, 'Token Usage (Input vs Output)');
            } else {
                tokenUsageCtx.clearRect(0, 0, tokenUsageCtx.canvas.width, tokenUsageCtx.canvas.height);
                tokenUsageCtx.font = "16px sans-serif";
                tokenUsageCtx.textAlign = "center";
                tokenUsageCtx.fillText("No Token Usage Data", tokenUsageCtx.canvas.width / 2, tokenUsageCtx.canvas.height / 2);
            }

            // Total Tokens Per Agent Chart
            if (tokensPerAgentChartInstance) tokensPerAgentChartInstance.destroy(); // Destroy previous instance
            const tokensPerAgentCtx = document.getElementById('tokens-per-agent-chart').getContext('2d'); 
            if (Object.keys(tokens_per_agent).length > 0) {
                // Create new instance and store it
                tokensPerAgentChartInstance = createPieChart(tokensPerAgentCtx, tokens_per_agent, 'Total Tokens Per Agent'); 
            } else {
                tokensPerAgentCtx.clearRect(0, 0, tokensPerAgentCtx.canvas.width, tokensPerAgentCtx.canvas.height);
                tokensPerAgentCtx.font = "16px sans-serif";
                tokensPerAgentCtx.textAlign = "center";
                tokensPerAgentCtx.fillText("No Agent Token Data", tokensPerAgentCtx.canvas.width / 2, tokensPerAgentCtx.canvas.height / 2);
            }
        }


        function renderProblematicPods(data) {
            const container = document.getElementById('problematic-pods');
            container.innerHTML = ''; // Clear previous
            if (data.problematic_pods && data.problematic_pods.problematic_pods && data.problematic_pods.problematic_pods.length > 0) {
                data.problematic_pods.problematic_pods.forEach(pod => {
                    const issues = pod.container_issues.map(issue => `
                        <li class="text-sm">
                            <span class="font-semibold">${issue.container_name}:</span>
                            <span class="text-red-700">${issue.reason}</span> (${issue.issue_type})
                            <p class="text-xs text-gray-500 pl-2">Restarts: ${issue.restart_count}</p>
                            <p class="text-xs text-gray-500 pl-2">Msg: ${issue.message || 'N/A'}</p>
                        </li>
                    `).join('');
                    
                    container.innerHTML += `
                        <div class="border border-red-200 bg-red-50 p-4 rounded-md">
                            <h4 class="font-bold text-red-800">${pod.pod_name}</h4>
                            <p class="text-xs text-gray-600">${pod.namespace} | Phase: ${pod.pod_phase}</p>
                            <ul class="list-disc list-inside mt-2 space-y-1">${issues}</ul>
                        </div>
                    `;
                });
            } else {
                container.innerHTML = `<p class="text-sm text-green-600">No problematic pods found.</p>`;
            }
        }

        function renderProblematicTraces(data) {
            const tbody = document.getElementById('problematic-traces');
            tbody.innerHTML = ''; // Clear previous
            if (data.problematic_traces && data.problematic_traces.traces && data.problematic_traces.traces.length > 0) {
                data.problematic_traces.traces.forEach(trace => {
                    const errorMsg = trace.error_message.split(';')[0]; // Get first error
                    tbody.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2 text-sm font-mono text-gray-700">${trace.traceID}</td>
                            <td class="px-4 py-2 text-sm text-gray-600">${trace.sequence}</td>
                            <td class="px-4 py-2 text-sm text-red-700" title="${trace.error_message}">${errorMsg}...</td>
                        </tr>
                    `;
                });
            } else if (data.problematic_traces && data.problematic_traces.info) {
                 tbody.innerHTML = `<tr><td colspan="3" class="px-4 py-3 text-sm text-green-600 text-center">${data.problematic_traces.info}</td></tr>`;
            } 
            else {
                tbody.innerHTML = `<tr><td colspan="3" class="px-4 py-3 text-sm text-green-600 text-center">No problematic traces found.</td></tr>`;
            }
        }

        function renderProblematicMetrics(data) {
            const container = document.getElementById('problematic-metrics');
            container.innerHTML = ''; // Clear previous
            if (data.problematic_metrics && data.problematic_metrics.problematic_metrics && data.problematic_metrics.problematic_metrics.length > 0) {
                 data.problematic_metrics.problematic_metrics.forEach(metric => {
                    container.innerHTML += `
                        <div class="border border-red-200 bg-red-50 p-4 rounded-md">
                            <h4 class="font-bold text-red-800">${metric.name}</h4>
                            <p class="text-sm text-gray-600">Value: ${metric.value}</p>
                            <p class="text-sm text-gray-600">Details: ${metric.details}</p>
                        </div>
                    `;
                 });
            } else if (data.problematic_metrics && data.problematic_metrics.info) {
                 container.innerHTML = `<p class="text-sm text-green-600">${data.problematic_metrics.info}</p>`;
            }
            else {
                container.innerHTML = `<p class="text-sm text-green-600">No problematic metrics found.</p>`;
            }
        }
        
        function renderSymptoms(data) {
            const list = document.getElementById('symptoms-list');
            list.innerHTML = ''; // Clear previous
            if(data.symptoms && data.symptoms.length > 0) {
                data.symptoms.forEach(symptom => {
                    // NEW: Accessing object properties
                    const mainPoint = symptom.potential_symptom || 'Symptom';
                    const evidence = symptom.evidence || 'No evidence.';
                    const resource = symptom.affected_resource || 'N/A';
                    const fullTitle = `Resource: ${resource}\nEvidence: ${evidence}`;
                    
                    list.innerHTML += `<li title="${fullTitle}">${mainPoint}</li>`;
                });
            } else {
                list.innerHTML = `<li class="text-sm text-green-600 list-none">No symptoms reported.</li>`;
            }
        }

        function renderSlowTraces(data) {
            const container = document.getElementById('slow-traces-container');
            container.innerHTML = ''; // Clear previous
            if (data.slow_traces && data.slow_traces.traces && data.slow_traces.traces.length > 0) {
                const slowTraces = data.slow_traces;
                const tracesCount = slowTraces.traces_count || slowTraces.traces.length;
                
                container.innerHTML += `
                    <div class="mb-4 p-3 bg-orange-50 border border-orange-200 rounded-lg">
                        <p class="text-sm text-gray-600">Service:</p>
                        <p class="text-lg font-mono text-orange-900">${slowTraces.service || 'Unknown'}</p>
                        <p class="text-xs text-gray-500 mt-1">Total Slow Traces: ${tracesCount}</p>
                    </div>
                `;

                slowTraces.traces.forEach((trace, idx) => {
                    const traceId = trace.trace_id || `trace-${idx}`;
                    const latency = trace.latency ? `${trace.latency.toLocaleString()} ms` : 'N/A';
                    const sequence = trace.sequence || 'N/A';
                    const hasError = trace.has_error ? 'Yes' : 'No';
                    
                    container.innerHTML += `
                        <div class="border border-orange-200 bg-orange-50 p-4 rounded-md">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-mono text-orange-800 font-bold break-all">${traceId}</h4>
                                <span class="text-xs font-semibold ${hasError === 'Yes' ? 'bg-red-200 text-red-700' : 'bg-green-200 text-green-700'} px-2 py-1 rounded">
                                    Error: ${hasError}
                                </span>
                            </div>
                            <p class="text-sm text-gray-700 mb-1"><span class="font-semibold">Latency:</span> ${latency}</p>
                            <p class="text-sm text-gray-700"><span class="font-semibold">Call Sequence:</span> <code class="bg-gray-200 text-gray-800 px-1 py-0.5 rounded text-xs">${sequence}</code></p>
                        </div>
                    `;
                });
            } else if (data.slow_traces && data.slow_traces.info) {
                container.innerHTML = `<p class="text-sm text-orange-600">${data.slow_traces.info}</p>`;
            } else {
                container.innerHTML = `<p class="text-sm text-orange-600">No slow traces available.</p>`;
            }
        }

        function renderRcaTasks(data) {
            const container = document.getElementById('rca-tasks-list');
            container.innerHTML = ''; // Clear previous
            if (data.rca_tasks && data.rca_tasks.length > 0) {
                // NEW: Iterating over an array of objects
                data.rca_tasks.forEach(task => {
                    const goal = task.investigation_goal || 'N/A';
                    const resource = task.target_resource || 'N/A';
                    const tools = task.suggested_tools || [];

                    const toolsList = tools.length > 0 ? tools.map(t => `<code class="bg-gray-200 text-gray-800 px-1 py-0.5 rounded text-xs">${t}</code>`).join(' ') : 'N/A';

                    container.innerHTML += `
                        <div class="border border-gray-200 p-4 rounded-md bg-gray-50">
                            <p class="font-semibold text-gray-800">${goal}</p>
                            <div class="text-sm mt-2 flex flex-wrap items-center gap-x-4 gap-y-1">
                                <span>Target: <code class="bg-blue-100 text-blue-800 px-1 py-0.5 rounded">${resource}</code></span>
                                <span class="flex items-center gap-1 flex-wrap">Tools: ${toolsList}</span>
                            </div>
                        </div>
                    `;
                });
            } else {
                container.innerHTML = `<p class="text-sm text-gray-500">No RCA tasks were planned.</p>`;
            }
        }
        
        function renderFinalReport(data) {
            const container = document.getElementById('final-report');
            container.innerHTML = '';
            if (!data.final_report) {
                 container.innerHTML = `<p class="text-sm text-gray-500">No final report available.</p>`;
                 return;
            }
            const report = data.final_report;
            
            const resourcesList = report.affected_resources.map(res => 
                `<li class="text-sm text-gray-700">${res}</li>`
            ).join('');
            
            container.innerHTML = `
                <div class="mb-4">
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Root Cause</h3>
                    <p class="text-gray-700">${report.root_cause}</p>
                </div>
                <div class="mb-4">
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Affected Resources</h3>
                    <ul class="list-disc list-inside space-y-1">${resourcesList}</ul>
                </div>
                <div class="mb-4">
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Evidence Summary</h3>
                    <p class="text-gray-700 whitespace-pre-line">${report.evidence_summary}</p>
                </div>
                <div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Investigation Summary</h3>
                    <p class="text-gray-700 whitespace-pre-line">${report.investigation_summary}</p>
                </div>
            `;

            // Add event listener for the new summarize button
            const summarizeBtn = document.getElementById('summarize-report-btn');
            // Remove existing listener to prevent duplicates on file reload
            summarizeBtn.removeEventListener('click', handleSummarizeReport); 
            summarizeBtn.addEventListener('click', handleSummarizeReport);
        }

        function handleSummarizeReport() {
            const rootCause = window.reportData?.final_report?.root_cause || 'No root cause found.';
            const summary = window.reportData?.final_report?.investigation_summary || 'No summary found.';
            
            const prompt = `You are an SRE expert explaining a technical incident to a non-technical executive. 
Summarize the following root cause and investigation summary in 2-3 simple sentences. 
Focus on business impact (what broke) and the core reason (why it broke), avoiding technical jargon.

Root Cause: ${rootCause}

Summary: ${summary}`;
            
            callGeminiAPI(prompt);
        }

        function renderRcaAnalyses(data) {
            const container = document.getElementById('rca-analyses');
            container.innerHTML = ''; // Clear previous
            
            // Destroy old RCA accordion charts
            activeRcaCharts.forEach(chart => chart.destroy());
            activeRcaCharts = [];

            if (data.rca_analyses_list && data.rca_analyses_list.length > 0) {
                data.rca_analyses_list.forEach((analysis, index) => {
                    const cardId = `rca-card-${index}`;
                    const chartId = `rca-chart-${index}`;
                    
                    const insightsList = analysis.insights.map(item => `<li class="text-sm">${item}</li>`).join('');
                    const stepsList = analysis.steps_performed.map(item => `<li class="text-sm font-mono">${item}</li>`).join('');
                    
                    const el = document.createElement('div');
                    el.className = 'bg-white rounded-lg shadow-md overflow-hidden';
                    
                    // Escape quotes for data attributes
                    const escapedDiagnosis = analysis.diagnosis.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    const escapedReasoning = analysis.reasoning.replace(/"/g, '&quot;').replace(/'/g, '&#39;');

                    el.innerHTML = `
                        <button class="accordion-button w-full p-4 text-left bg-gray-50 hover:bg-gray-100 transition duration-150" data-target="${cardId}">
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-semibold text-blue-700">
                                    Task: ${analysis.task.investigation_goal.split(':')[0]}
                                </span>
                                <span class="arrow text-blue-700 text-2xl font-bold transform transition-transform duration-300">&#x25B8;</span> <!-- Right arrow --></div>
                            <p class="text-sm text-gray-600 mt-1">Target: <code class="bg-gray-200 text-gray-800 px-1 py-0.5 rounded">${analysis.task.target_resource}</code> (${analysis.task.resource_type})</p>
                        </button>
                        
                        <div id="${cardId}" class="accordion-content p-6 border-t border-gray-200">
                            <!-- Tabs for switching between Details and Chat --><div class="mb-4">
                                <div class="flex gap-2 border-b border-gray-200">
                                    <button class="tab-button active px-4 py-2 text-sm font-semibold text-blue-700 border-b-2 border-blue-700 bg-blue-50" data-tab="details-${index}">
                                        ðŸ“Š Details & Analysis
                                    </button>
                                    <button class="tab-button px-4 py-2 text-sm font-semibold text-gray-600 hover:text-blue-700 border-b-2 border-transparent" data-tab="chat-${index}">
                                        ðŸ’¬ Tool Interaction
                                    </button>
                                </div>
                            </div>

                            <!-- Details Tab --><div id="details-${index}" class="tab-content active">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <!-- Left side: Details --><div class="md:col-span-2 space-y-4">
                                        <div>
                                            <div class="flex justify-between items-center mb-1">
                                                <h4 class="text-md font-semibold text-gray-800">Diagnosis</h4>
                                                <button class="explain-diagnosis-btn bg-blue-50 hover:bg-blue-100 text-blue-700 font-semibold py-1 px-3 rounded-full text-xs flex items-center"
                                                    data-diagnosis="${escapedDiagnosis}"
                                                    data-reasoning="${escapedReasoning}">
                                                    <span class="mr-1">âœ¨</span> Explain
                                                </button>
                                            </div>
                                            <p class="text-sm text-gray-600">${analysis.diagnosis}</p>
                                        </div>
                                        <div>
                                            <h4 class="text-md font-semibold text-gray-800 mb-1">Reasoning</h4>
                                            <p class="text-sm text-gray-600">${analysis.reasoning}</p>
                                        </div>
                                        <div>
                                            <h4 class="text-md font-semibold text-gray-800 mb-1">Key Insights</h4>
                                            <ul class="list-disc list-inside space-y-1">${insightsList}</ul>
                                        </div>
                                        <div>
                                            <h4 class="text-md font-semibold text-gray-800 mb-1">Steps Performed</h4>
                                            <ul class="list-decimal list-inside space-y-1">${stepsList}</ul>
                                        </div>
                                    </div>
                                    <!-- Right side: Chart --><div class="md:col-span-1 relative min-h-[250px]">
                                        <canvas id="${chartId}"></canvas>
                                    </div>
                                </div>
                            </div>

                            <!-- Chat Tab --><div id="chat-${index}" class="tab-content hidden">
                                <div class="bg-gray-50 rounded-lg p-4 max-h-[600px] overflow-y-auto space-y-3" id="chat-messages-${index}">
                                    <!-- Chat messages will be injected here -->
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(el);
                    
                    // Render chat messages
                    const chatContainer = el.querySelector(`#chat-messages-${index}`);
                    if (analysis.message_history && analysis.message_history.length > 0) {
                        let lastRole = '';
                        analysis.message_history.forEach((msg, msgIdx) => {
                            const role = msg.role || 'user';
                            const isUser = role === 'user';
                            const isTool = role === 'tool' || msg.type === 'tool';
                            
                            const msgClass = isUser ? 'bg-blue-50 border-l-4 border-blue-500' : isTool ? 'bg-green-50 border-l-4 border-green-500' : 'bg-purple-50 border-l-4 border-purple-500';
                            const roleLabel = isUser ? 'ðŸ‘¤ Agent' : isTool ? 'ðŸ”§ Tool Response' : 'ðŸ¤– Assistant';
                            
                            // Try to truncate long content
                            let content = msg.content || '';
                            if (typeof content === 'object') {
                                content = JSON.stringify(content, null, 2);
                            }
                            const displayContent = content.length > 500 ? content.substring(0, 500) + '...' : content;
                            
                            chatContainer.innerHTML += `
                                <div class="p-3 rounded-md ${msgClass} text-sm">
                                    <div class="font-semibold text-xs text-gray-700 mb-1">${roleLabel}</div>
                                    <div class="text-gray-700 font-mono text-xs whitespace-pre-wrap break-words">${displayContent}</div>
                                </div>
                            `;
                        });
                    } else {
                        chatContainer.innerHTML = `<p class="text-sm text-gray-500 text-center py-4">No interaction history available.</p>`;
                    }
                    
                    // Add tab switching functionality
                    const tabButtons = el.querySelectorAll('.tab-button');
                    tabButtons.forEach(btn => {
                        btn.addEventListener('click', () => {
                            // Remove active class from all buttons and content
                            el.querySelectorAll('.tab-button').forEach(b => {
                                b.classList.remove('active', 'text-blue-700', 'border-b-blue-700', 'bg-blue-50');
                                b.classList.add('text-gray-600', 'border-b-transparent');
                            });
                            el.querySelectorAll('.tab-content').forEach(tc => {
                                tc.classList.add('hidden');
                                tc.classList.remove('active');
                            });
                            
                            // Add active class to clicked button and corresponding content
                            btn.classList.add('active', 'text-blue-700', 'border-b-2', 'border-b-blue-700', 'bg-blue-50');
                            btn.classList.remove('text-gray-600', 'border-b-transparent');
                            const tabId = btn.dataset.tab;
                            const content = el.querySelector(`#${tabId}`);
                            if (content) {
                                content.classList.remove('hidden');
                                content.classList.add('active');
                            }
                        });
                    });
                    
                    // Add accordion functionality
                    const button = el.querySelector('.accordion-button');
                    button.addEventListener('click', () => {
                        const content = document.getElementById(button.dataset.target);
                        const wasActive = button.classList.contains('active');
                        
                        if (content) {
                            if (!wasActive) {
                                button.classList.toggle('active');
                                // Create the chart only when opening
                                // Check if chart already exists
                                const existingChart = Chart.getChart(chartId);
                                if (!existingChart) {
                                    const ctx = document.getElementById(chartId).getContext('2d');
                                    // Create the chart and add it to the RCA cleanup array
                                    const newChart = createPieChart(ctx, analysis.tools_stats);
                                    activeRcaCharts.push(newChart);
                                }
                            } else {
                                 button.classList.remove('active');
                            }
                        }
                    });

                    // Add event listener for the new explain button
                    const explainBtn = el.querySelector('.explain-diagnosis-btn');
                    if (explainBtn) { // Ensure button exists before adding listener
                        explainBtn.addEventListener('click', (e) => {
                            e.stopPropagation(); // Prevent accordion from toggling
                            const btn = e.currentTarget;
                            const diagnosis = btn.dataset.diagnosis;
                            const reasoning = btn.dataset.reasoning;

                            const prompt = `You are a senior SRE explaining a technical concept to a junior engineer. 
Please explain the following diagnosis and reasoning in simpler terms. 
Focus on what the finding means and the direct cause-and-effect.

Diagnosis: ${diagnosis}

Reasoning: ${reasoning}`;
                            
                            callGeminiAPI(prompt);
                        });
                    }
                });
                
            } else {
                container.innerHTML = `<p class="text-sm text-gray-500">No RCA analyses were performed.</p>`;
            }
        }
        
        // --- INITIALIZATION ---
        
        function handleFileLoad() {
            const fileInput = document.getElementById('json-file-input');
            const reportContent = document.getElementById('report-content');
            const errorMessage = document.getElementById('error-message');

            const file = fileInput.files[0];
            if (!file) {
                errorMessage.textContent = 'Please select a file first.';
                errorMessage.classList.remove('hidden');
                return;
            }

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const fileContent = e.target.result;
                    const jsonData = JSON.parse(fileContent);
                    window.reportData = jsonData; // Store data globally
                    
                    // Clear error and render all sections
                    errorMessage.classList.add('hidden');
                    
                    renderExperimentName(jsonData);
                    renderAppInfo(jsonData);
                    renderExecutionStatistics(jsonData); // Creates stats charts
                    renderProblematicPods(jsonData);
                    renderProblematicTraces(jsonData);
                    renderProblematicMetrics(jsonData);
                    renderSymptoms(jsonData);
                    renderSlowTraces(jsonData);
                    renderRcaTasks(jsonData);
                    renderRcaAnalyses(jsonData); // Cleans up *only* old RCA charts
                    renderFinalReport(jsonData);

                    // Show the report
                    reportContent.classList.remove('hidden');

                } catch (error) {
                    console.error('Failed to parse JSON:', error);
                    errorMessage.textContent = `Error loading file: ${error.message}. Please ensure it is a valid JSON file.`;
                    errorMessage.classList.remove('hidden');
                    reportContent.classList.add('hidden');
                }
            };
            
            reader.onerror = function() {
                console.error('Failed to read file');
                errorMessage.textContent = 'Error reading the file.';
                errorMessage.classList.remove('hidden');
                reportContent.classList.add('hidden');
            };

            reader.readAsText(file);
        }

        function initApp() {
           document.getElementById('load-report-btn').addEventListener('click', handleFileLoad);
           
           // Add modal close listeners
           closeModalBtn.addEventListener('click', hideModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    hideModal();
                }
            });
        }

        // Run the app setup once the DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>

