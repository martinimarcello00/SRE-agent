<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRE Agent Report Explorer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for plotting -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom styles for the accordion */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .accordion-button.active + .accordion-content {
            max-height: 5000px; /* A large value to ensure content fits */
            overflow: visible;
        }
        .accordion-button .arrow {
            transition: transform 0.3s ease-out;
        }
        .accordion-button.active .arrow {
            transform: rotate(90deg);
        }
    </style>
</head>
<body class="h-full font-sans text-gray-800">
    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-blue-700 mb-2">SRE Agent Execution Report</h1>
            <p class="text-lg text-gray-600">An interactive explorer for the agent's findings and root cause analysis.</p>
        </header>

        <!-- File Upload Section -->
        <div id="file-loader" class="bg-white p-6 rounded-lg shadow-md border border-blue-200 mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Load Report File</h2>
            <div class="flex items-center space-x-4">
                <input type="file" id="json-file-input" accept="application/json" class="block w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-lg file:border-0
                    file:text-sm file:font-semibold
                    file:bg-blue-50 file:text-blue-700
                    hover:file:bg-blue-100 transition duration-150
                "/>
                <button id="load-report-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition duration-150">
                    Load Report
                </button>
            </div>
            <div id="error-message" class="text-red-600 text-sm mt-4 hidden"></div>
        </div>

        <!-- Main Report Content (Initially Hidden) -->
        <div id="report-content" class="hidden space-y-8">

            <!-- App Info Card -->
            <div id="app-info-card" class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold text-blue-600 border-b border-gray-200 pb-2 mb-4">Application Info</h2>
                <div id="app-info">
                    <!-- Content will be injected by JS -->
                </div>
            </div>

            <!-- Symptoms Section -->
            <div class="bg-white p-6 rounded-lg shadow-md border border-yellow-200">
                <h2 class="text-3xl font-bold text-yellow-700 border-b border-gray-200 pb-2 mb-4">Symptoms Section (Triage Agent)</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    
                    <!-- Problematic Pods -->
                    <div>
                        <h3 class="text-2xl font-semibold text-red-600 mb-4">Problematic Pods</h3>
                        <div id="problematic-pods" class="space-y-4">
                            <!-- Content will be injected by JS -->
                        </div>
                    </div>

                    <!-- Problematic Traces -->
                    <div>
                        <h3 class="text-2xl font-semibold text-red-600 mb-4">Problematic Traces</h3>
                        <div id="problematic-traces-container" class="overflow-x-auto max-h-96 border rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trace ID</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sequence</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Error</th>
                                    </tr>
                                </thead>
                                <tbody id="problematic-traces" class="bg-white divide-y divide-gray-200">
                                    <!-- Content will be injected by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Problematic Metrics -->
                    <div class="lg:col-span-1">
                        <h3 class="text-2xl font-semibold text-red-600 mb-4">Problematic Metrics</h3>
                        <div id="problematic-metrics" class="space-y-4">
                            <!-- Content will be injected by JS -->
                        </div>
                    </div>

                    <!-- AI-Generated Symptoms -->
                    <div class="lg:col-span-1">
                        <h3 class="text-2xl font-semibold text-yellow-600 mb-4">AI-Generated Symptoms</h3>
                        <ul id="symptoms-list" class="list-disc list-inside space-y-2 text-sm">
                            <!-- Content will be injected by JS -->
                        </ul>
                    </div>
                </div>
            </div>

            <!-- RCA Tasks Section -->
            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <h2 class="text-3xl font-bold text-gray-800 border-b border-gray-200 pb-2 mb-4">RCA Tasks (Planner Agent)</h2>
                <div id="rca-tasks-list" class="space-y-3">
                    <!-- Content will be injected by JS -->
                </div>
            </div>
            
            <!-- RCA Analyses Section -->
            <div>
                <h2 class="text-3xl font-bold text-gray-800 mb-4">RCA Analyses & Tool Usage</h2>
                <div id="rca-analyses" class="space-y-4">
                    <!-- Accordions will be injected by JS -->
                </div>
            </div>

            <!-- Final Report Card -->
            <div class="bg-white p-6 rounded-lg shadow-xl border border-blue-200">
                <h2 class="text-3xl font-bold text-blue-800 border-b border-gray-200 pb-2 mb-4">Final Report (Supervisor Agent)</h2>
                <div id="final-report" class="space-y-4">
                    <!-- Content will be injected by JS -->
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- CHART HELPER ---
        // Predefined colors for charts to make them consistent
        const chartColors = [
            '#4F46E5', // Indigo
            '#10B981', // Emerald
            '#EF4444', // Red
            '#F59E0B', // Amber
            '#3B82F6', // Blue
            '#6366F1', // Indigo (light)
            '#14B8A6', // Teal
            '#EC4899', // Pink
            '#8B5CF6', // Violet
            '#06B6D4'  // Cyan
        ];

        let activeCharts = []; // To destroy charts on reload

        function createPieChart(ctx, toolsStats) {
            const labels = Object.keys(toolsStats);
            const data = Object.values(toolsStats);
            const backgroundColors = labels.map((_, i) => chartColors[i % chartColors.length]);

            const chart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Tool Usage',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        title: {
                            display: true,
                            text: 'Tool Call Count per Task'
                        }
                    }
                }
            });
            activeCharts.push(chart);
        }

        // --- RENDER FUNCTIONS ---

        function renderAppInfo(data) {
            const container = document.getElementById('app-info');
            if (!data.app_name) {
                container.innerHTML = `<p class="text-gray-500">App info not available.</p>`;
                return;
            }
            container.innerHTML = `
                <div class="mb-2">
                    <strong class="text-gray-700">App Name:</strong>
                    <span class="text-gray-900 ml-2">${data.app_name}</span>
                </div>
                <div class="mb-2">
                    <strong class="text-gray-700">Namespace:</strong>
                    <span class="text-gray-900 ml-2">${data.target_namespace}</span>
                </div>
                <div>
                    <strong class="text-gray-700">Summary:</strong>
                    <p class="text-gray-600 text-sm mt-1 whitespace-pre-line">${data.app_summary ? data.app_summary.trim() : 'N/A'}</p>
                </div>
            `;
        }

        function renderProblematicPods(data) {
            const container = document.getElementById('problematic-pods');
            container.innerHTML = ''; // Clear previous
            if (data.problematic_pods && data.problematic_pods.problematic_pods && data.problematic_pods.problematic_pods.length > 0) {
                data.problematic_pods.problematic_pods.forEach(pod => {
                    const issues = pod.container_issues.map(issue => `
                        <li class="text-sm">
                            <span class="font-semibold">${issue.container_name}:</span>
                            <span class="text-red-700">${issue.reason}</span> (${issue.issue_type})
                            <p class="text-xs text-gray-500 pl-2">Restarts: ${issue.restart_count}</p>
                            <p class="text-xs text-gray-500 pl-2">Msg: ${issue.message}</p>
                        </li>
                    `).join('');
                    
                    container.innerHTML += `
                        <div class="border border-red-200 bg-red-50 p-4 rounded-md">
                            <h4 class="font-bold text-red-800">${pod.pod_name}</h4>
                            <p class="text-xs text-gray-600">${pod.namespace} | Phase: ${pod.pod_phase}</p>
                            <ul class="list-disc list-inside mt-2 space-y-1">${issues}</ul>
                        </div>
                    `;
                });
            } else {
                container.innerHTML = `<p class="text-sm text-green-600">No problematic pods found.</p>`;
            }
        }

        function renderProblematicTraces(data) {
            const tbody = document.getElementById('problematic-traces');
            tbody.innerHTML = ''; // Clear previous
            if (data.problematic_traces && data.problematic_traces.traces && data.problematic_traces.traces.length > 0) {
                data.problematic_traces.traces.forEach(trace => {
                    const errorMsg = trace.error_message.split(';')[0]; // Get first error
                    tbody.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2 text-sm font-mono text-gray-700">${trace.traceID}</td>
                            <td class="px-4 py-2 text-sm text-gray-600">${trace.sequence}</td>
                            <td class="px-4 py-2 text-sm text-red-700" title="${trace.error_message}">${errorMsg}...</td>
                        </tr>
                    `;
                });
            } else if (data.problematic_traces && data.problematic_traces.info) {
                 tbody.innerHTML = `<tr><td colspan="3" class="px-4 py-3 text-sm text-green-600 text-center">${data.problematic_traces.info}</td></tr>`;
            } 
            else {
                tbody.innerHTML = `<tr><td colspan="3" class="px-4 py-3 text-sm text-green-600 text-center">No problematic traces found.</td></tr>`;
            }
        }

        function renderProblematicMetrics(data) {
            const container = document.getElementById('problematic-metrics');
            container.innerHTML = ''; // Clear previous
            if (data.problematic_metrics && data.problematic_metrics.problematic_metrics && data.problematic_metrics.problematic_metrics.length > 0) {
                 data.problematic_metrics.problematic_metrics.forEach(metric => {
                    container.innerHTML += `
                        <div class="border border-red-200 bg-red-50 p-4 rounded-md">
                            <h4 class="font-bold text-red-800">${metric.name}</h4>
                            <p class="text-sm text-gray-600">Value: ${metric.value}</p>
                            <p class="text-sm text-gray-600">Details: ${metric.details}</p>
                        </div>
                    `;
                 });
            } else if (data.problematic_metrics && data.problematic_metrics.info) {
                 container.innerHTML = `<p class="text-sm text-green-600">${data.problematic_metrics.info}</p>`;
            }
            else {
                container.innerHTML = `<p class="text-sm text-green-600">No problematic metrics found.</p>`;
            }
        }
        
        function renderSymptoms(data) {
            const list = document.getElementById('symptoms-list');
            list.innerHTML = ''; // Clear previous
            if(data.symptoms && data.symptoms.length > 0) {
                data.symptoms.forEach(symptom => {
                    // NEW: Accessing object properties
                    const mainPoint = symptom.potential_symptom || 'Symptom';
                    const evidence = symptom.evidence || 'No evidence.';
                    const resource = symptom.affected_resource || 'N/A';
                    const fullTitle = `Resource: ${resource}\nEvidence: ${evidence}`;
                    
                    list.innerHTML += `<li title="${fullTitle}">${mainPoint}</li>`;
                });
            } else {
                list.innerHTML = `<li class="text-sm text-green-600 list-none">No symptoms reported.</li>`;
            }
        }

        function renderRcaTasks(data) {
            const container = document.getElementById('rca-tasks-list');
            container.innerHTML = ''; // Clear previous
            if (data.rca_tasks && data.rca_tasks.length > 0) {
                // NEW: Iterating over an array of objects
                data.rca_tasks.forEach(task => {
                    const goal = task.investigation_goal || 'N/A';
                    const resource = task.target_resource || 'N/A';
                    const tools = task.suggested_tools || [];

                    const toolsList = tools.length > 0 ? tools.map(t => `<code class="bg-gray-200 text-gray-800 px-1 py-0.5 rounded text-xs">${t}</code>`).join(' ') : 'N/A';

                    container.innerHTML += `
                        <div class="border border-gray-200 p-4 rounded-md bg-gray-50">
                            <p class="font-semibold text-gray-800">${goal}</p>
                            <div class="text-sm mt-2 flex flex-wrap items-center gap-x-4 gap-y-1">
                                <span>Target: <code class="bg-blue-100 text-blue-800 px-1 py-0.5 rounded">${resource}</code></span>
                                <span class="flex items-center gap-1 flex-wrap">Tools: ${toolsList}</span>
                            </div>
                        </div>
                    `;
                });
            } else {
                container.innerHTML = `<p class="text-sm text-gray-500">No RCA tasks were planned.</p>`;
            }
        }
        
        function renderFinalReport(data) {
            const container = document.getElementById('final-report');
            container.innerHTML = '';
            if (!data.final_report) {
                 container.innerHTML = `<p class="text-sm text-gray-500">No final report available.</p>`;
                 return;
            }
            const report = data.final_report;
            
            const resourcesList = report.affected_resources.map(res => 
                `<li class="text-sm text-gray-700">${res}</li>`
            ).join('');
            
            container.innerHTML = `
                <div class="mb-4">
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Root Cause</h3>
                    <p class="text-gray-700">${report.root_cause}</p>
                </div>
                <div class="mb-4">
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Affected Resources</h3>
                    <ul class="list-disc list-inside space-y-1">${resourcesList}</ul>
                </div>
                <div class="mb-4">
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Evidence Summary</h3>
                    <p class="text-gray-700 whitespace-pre-line">${report.evidence_summary}</p>
                </div>
                <div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Investigation Summary</h3>
                    <p class="text-gray-700 whitespace-pre-line">${report.investigation_summary}</p>
                </div>
            `;
        }

        function renderRcaAnalyses(data) {
            const container = document.getElementById('rca-analyses');
            container.innerHTML = ''; // Clear previous
            
            // Destroy old charts
            activeCharts.forEach(chart => chart.destroy());
            activeCharts = [];

            if (data.rca_analyses_list && data.rca_analyses_list.length > 0) {
                data.rca_analyses_list.forEach((analysis, index) => {
                    const cardId = `rca-card-${index}`;
                    const chartId = `rca-chart-${index}`;
                    
                    const insightsList = analysis.insights.map(item => `<li class="text-sm">${item}</li>`).join('');
                    const stepsList = analysis.steps_performed.map(item => `<li class="text-sm font-mono">${item}</li>`).join('');
                    
                    const el = document.createElement('div');
                    el.className = 'bg-white rounded-lg shadow-md overflow-hidden';
                    el.innerHTML = `
                        <button class="accordion-button w-full p-4 text-left bg-gray-50 hover:bg-gray-100 transition duration-150" data-target="${cardId}">
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-semibold text-blue-700">
                                    Task: ${analysis.task.investigation_goal.split(':')[0]}
                                </span>
                                <span class="arrow text-blue-700 text-2xl font-bold transform transition-transform duration-300">&#x25B8;</span> <!-- Right arrow -->
                            </div>
                            <p class="text-sm text-gray-600 mt-1">Target: <code class="bg-gray-200 text-gray-800 px-1 py-0.5 rounded">${analysis.task.target_resource}</code> (${analysis.task.resource_type})</p>
                        </button>
                        
                        <div id="${cardId}" class="accordion-content p-6 border-t border-gray-200">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <!-- Left side: Details -->
                                <div class="md:col-span-2 space-y-4">
                                    <div>
                                        <h4 class="text-md font-semibold text-gray-800 mb-1">Diagnosis</h4>
                                        <p class="text-sm text-gray-600">${analysis.diagnosis}</p>
                                    </div>
                                    <div>
                                        <h4 class="text-md font-semibold text-gray-800 mb-1">Reasoning</h4>
                                        <p class="text-sm text-gray-600">${analysis.reasoning}</p>
                                    </div>
                                    <div>
                                        <h4 class="text-md font-semibold text-gray-800 mb-1">Key Insights</h4>
                                        <ul class="list-disc list-inside space-y-1">${insightsList}</ul>
                                    </div>
                                    <div>
                                        <h4 class="text-md font-semibold text-gray-800 mb-1">Steps Performed</h4>
                                        <ul class="list-decimal list-inside space-y-1">${stepsList}</ul>
                                    </div>
                                </div>
                                <!-- Right side: Chart -->
                                <div class="md:col-span-1 flex items-center justify-center min-h-[250px] relative">
                                    <canvas id="${chartId}"></canvas>
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(el);
                    
                    // Add accordion functionality
                    const button = el.querySelector('.accordion-button');
                    button.addEventListener('click', () => {
                        const content = document.getElementById(button.dataset.target);
                        const wasActive = button.classList.contains('active');
                        
                        // Close all others
                        // container.querySelectorAll('.accordion-button').forEach(btn => {
                        //     btn.classList.remove('active');
                        // });

                        if (content) {
                            if (!wasActive) {
                                button.classList.toggle('active');
                                // Create the chart only when opening
                                // Check if chart already exists
                                const existingChart = Chart.getChart(chartId);
                                if (!existingChart) {
                                    const ctx = document.getElementById(chartId).getContext('2d');
                                    createPieChart(ctx, analysis.tools_stats);
                                }
                            } else {
                                 button.classList.remove('active');
                            }
                        }
                    });
                });
                
            } else {
                container.innerHTML = `<p class="text-sm text-gray-500">No RCA analyses were performed.</p>`;
            }
        }
        
        // --- INITIALIZATION ---
        
        function handleFileLoad() {
            const fileInput = document.getElementById('json-file-input');
            const reportContent = document.getElementById('report-content');
            const errorMessage = document.getElementById('error-message');

            const file = fileInput.files[0];
            if (!file) {
                errorMessage.textContent = 'Please select a file first.';
                errorMessage.classList.remove('hidden');
                return;
            }

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const fileContent = e.target.result;
                    const jsonData = JSON.parse(fileContent);
                    
                    // Clear error and render all sections
                    errorMessage.classList.add('hidden');
                    
                    renderAppInfo(jsonData);
                    renderProblematicPods(jsonData);
                    renderProblematicTraces(jsonData);
                    renderProblematicMetrics(jsonData);
                    renderSymptoms(jsonData);
                    renderRcaTasks(jsonData);
                    renderRcaAnalyses(jsonData);
                    renderFinalReport(jsonData);

                    // Show the report
                    reportContent.classList.remove('hidden');

                } catch (error) {
                    console.error('Failed to parse JSON:', error);
                    errorMessage.textContent = `Error loading file: ${error.message}. Please ensure it is a valid JSON file.`;
                    errorMessage.classList.remove('hidden');
                    reportContent.classList.add('hidden');
                }
            };
            
            reader.onerror = function() {
                console.error('Failed to read file');
                errorMessage.textContent = 'Error reading the file.';
                errorMessage.classList.remove('hidden');
                reportContent.classList.add('hidden');
            };

            reader.readAsText(file);
        }

        function initApp() {
           document.getElementById('load-report-btn').addEventListener('click', handleFileLoad);
        }

        // Run the app setup once the DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>


